name: Deploy Product API

on:
  push:
    branches:
      - main  # trigger on push to main branch

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: 21
        distribution: temurin

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Copy JAR to app directory
      run: |
        sudo mkdir -p /opt/backend-app

        # Ensure JAR exists
        JAR_FILE=$(ls build/libs/*.jar | head -n 1)
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: No JAR found in build/libs!"
          exit 1
        fi

        # Copy and rename to app.jar
        sudo cp "$JAR_FILE" /opt/backend-app/app.jar
        sudo chown ubuntu:ubuntu /opt/backend-app/app.jar
        echo "Copied $JAR_FILE to /opt/backend-app/app.jar"

    - name: Restart Spring Boot service
      run: |
        SERVICE_FILE=/etc/systemd/system/backend-app.service

        if ! sudo systemctl list-units --full -all | grep -q "backend-app.service"; then
          echo "[INFO] Creating systemd service for backend-app"
          echo "[Unit]
          Description=Backend Product API
          After=network.target

          [Service]
          User=ubuntu
          ExecStart=/usr/bin/java -jar /opt/backend-app/app.jar
          SuccessExitStatus=143
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target" | sudo tee $SERVICE_FILE
        fi

        sudo systemctl daemon-reload
        sudo systemctl enable backend-app.service
        sudo systemctl restart backend-app.service
        echo "[INFO] backend-app.service restarted successfully"

    - name: Show logs
      run: sudo journalctl -u backend-app.service -n 20 --no-pager
